<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - AI Creative Studio</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Admin specific styles overriding or extending style.css */
        
        /* Table Styles */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .admin-table th, .admin-table td {
            text-align: left;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .admin-table th {
            font-weight: 600;
            color: var(--text-light);
            background-color: #f8fafc;
        }
        
        .admin-table tr:hover {
            background-color: #f1f5f9;
        }
        
        /* Action Buttons */
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
            border-radius: 6px;
        }

        /* Pricing Grid */
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .pricing-card {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.2s;
        }

        .pricing-card:hover {
            border-color: #ff4757;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.1);
        }

        .pricing-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            display: block;
        }

        .pricing-input-group {
            margin-top: 15px;
        }
        
        .pricing-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Navigation -->
        <nav class="navbar">
            <div class="logo">ğŸ›¡ï¸ Admin</div>
            <div class="nav-links">
                <div class="nav-item active" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</div>
                <div class="nav-item" onclick="switchTab('pricing')">ä»·æ ¼é…ç½®</div>
                <div class="nav-item" onclick="switchTab('api')">API è®¾ç½®</div>
            </div>
            <div class="nav-auth">
                <button class="btn-auth" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="content-wrapper">
            
            <!-- Users Tab -->
            <div id="tab-users" class="tab-content active">
                <div class="hero-text" style="text-align: left; margin-bottom: 2rem;">
                    <h1>ç”¨æˆ·ç®¡ç†</h1>
                    <p>æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨åŠç®¡ç†ç”¨æˆ·ä½™é¢ã€‚</p>
                </div>
                
                <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                    <button class="secondary-btn" onclick="loadUsers()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
                </div>

                <div style="overflow-x: auto;">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>é‚®ç®±</th>
                                <th>ä½™é¢ (Credits)</th>
                                <th>çŠ¶æ€</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="users-list">
                            <!-- Users injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pricing Tab -->
            <div id="tab-pricing" class="tab-content">
                <div class="hero-text" style="text-align: left; margin-bottom: 2rem;">
                    <h1>ä»·æ ¼é…ç½®</h1>
                    <p>è®¾ç½®å„é¡¹ç”ŸæˆæœåŠ¡çš„å•æ¬¡æ¶ˆè€—ç®—åŠ›ã€‚</p>
                </div>

                <div class="pricing-grid">
                    <div class="pricing-card">
                        <span class="pricing-icon">ğŸ¥</span>
                        <h3>è§†é¢‘ç”Ÿæˆ</h3>
                        <div class="pricing-input-group">
                            <label>å•æ¬¡æ¶ˆè€— (Credits)</label>
                            <input type="number" id="price-video" step="0.1" placeholder="0.0">
                        </div>
                    </div>

                    <div class="pricing-card">
                        <span class="pricing-icon">ğŸ–¼ï¸</span>
                        <h3>å›¾ç‰‡ç”Ÿæˆ</h3>
                        <div class="pricing-input-group">
                            <label>å•æ¬¡æ¶ˆè€— (Credits)</label>
                            <input type="number" id="price-image" step="0.1" placeholder="0.0">
                        </div>
                    </div>

                    <div class="pricing-card">
                        <span class="pricing-icon">ğŸµ</span>
                        <h3>éŸ³ä¹ç”Ÿæˆ</h3>
                        <div class="pricing-input-group">
                            <label>å•æ¬¡æ¶ˆè€— (Credits)</label>
                            <input type="number" id="price-music" step="0.1" placeholder="0.0">
                        </div>
                    </div>

                    <div class="pricing-card">
                        <span class="pricing-icon">ğŸ‘¤</span>
                        <h3>æ•°å­—äºº</h3>
                        <div class="pricing-input-group">
                            <label>å•æ¬¡æ¶ˆè€— (Credits)</label>
                            <input type="number" id="price-avatar" step="0.1" placeholder="0.0">
                        </div>
                    </div>
                </div>

                <div style="margin-top: 2rem; text-align: right;">
                    <button class="primary-btn" style="width: auto;" onclick="savePricing()">ğŸ’¾ ä¿å­˜ä»·æ ¼é…ç½®</button>
                </div>
            </div>

            <!-- API Tab -->
            <div id="tab-api" class="tab-content">
                <div class="hero-text" style="text-align: left; margin-bottom: 2rem;">
                    <h1>API è®¾ç½®</h1>
                    <p>é…ç½®åå°ç®¡ç†å¯†ç åŠç¬¬ä¸‰æ–¹æœåŠ¡å¯†é’¥ã€‚</p>
                </div>
                
                <div class="input-section">
                    <div class="form-group">
                        <label>ç®¡ç†å¯†ç  (ç”¨äºéªŒè¯èº«ä»½)</label>
                        <input type="password" id="admin-password" placeholder="è¾“å…¥ç®¡ç†å¯†ç ">
                        <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 5px;">
                            æ­¤å¯†ç ç”¨äºæ‰€æœ‰æ•æ„Ÿæ“ä½œçš„éªŒè¯ã€‚
                        </p>
                    </div>

                    <div class="form-group" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                        <label>è¿è¡Œæ¨¡å¼</label>
                        <select id="mock-mode">
                            <option value="true">Mock æ¨¡å¼ (æ— éœ€ Keyï¼Œæ¨¡æ‹Ÿç”Ÿæˆ)</option>
                            <option value="false">å®æˆ˜æ¨¡å¼ (è°ƒç”¨çœŸå® API)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Sora2 API Key (è§†é¢‘)</label>
                        <input type="password" id="sora-key" placeholder="sk-...">
                    </div>

                    <div class="form-group">
                        <label>Veo API Key (è§†é¢‘)</label>
                        <input type="password" id="veo-key" placeholder="sk-...">
                    </div>

                    <div class="form-group">
                        <label>Suno API Key (éŸ³ä¹)</label>
                        <input type="password" id="suno-key" placeholder="sk-...">
                    </div>

                    <div class="form-group">
                        <label>HeyGen API Key (æ•°å­—äºº)</label>
                        <input type="password" id="heygem-key" placeholder="sk-...">
                    </div>

                    <button class="primary-btn" onclick="saveAdminConfig()">ä¿å­˜é…ç½®</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Tab Switching
        function switchTab(tabId) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Load data if needed
            if (tabId === 'users') loadUsers();
            if (tabId === 'pricing') loadPricing();
            if (tabId === 'api') loadApiConfig();
        }

        // Auth / Config
        function getAdminPassword() {
            return localStorage.getItem('admin_password') || '';
        }

        async function loadApiConfig() {
            const pwd = getAdminPassword();
            if (!pwd) return;

            try {
                const res = await fetch(`/api/admin/config?password=${pwd}`);
                if (res.ok) {
                    const config = await res.json();
                    document.getElementById('mock-mode').value = config.mock_mode.toString();
                    document.getElementById('sora-key').value = config.sora_api_key || '';
                    document.getElementById('veo-key').value = config.veo_api_key || '';
                    document.getElementById('suno-key').value = config.suno_api_key || '';
                    document.getElementById('heygem-key').value = config.heygem_api_key || '';
                }
            } catch (e) {
                console.error('Failed to load config', e);
            }
        }

        async function saveAdminConfig() {
            const pwd = document.getElementById('admin-password').value;
            if (!pwd) {
                alert('è¯·è¾“å…¥ç®¡ç†å¯†ç ');
                return;
            }

            // Save locally for auth
            localStorage.setItem('admin_password', pwd);

            // Save to server
            const data = {
                password: pwd,
                mock_mode: document.getElementById('mock-mode').value === 'true',
                sora_api_key: document.getElementById('sora-key').value,
                veo_api_key: document.getElementById('veo-key').value,
                suno_api_key: document.getElementById('suno-key').value,
                heygem_api_key: document.getElementById('heygem-key').value
            };

            try {
                const res = await fetch('/api/admin/config', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('é…ç½®å·²ä¿å­˜');
                    loadUsers(); // Try to load users to test password
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç ');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        function logout() {
            localStorage.removeItem('admin_password');
            window.location.href = '/';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const savedPwd = localStorage.getItem('admin_password');
            if (savedPwd) {
                document.getElementById('admin-password').value = savedPwd;
                loadUsers();
                loadPricing();
            } else {
                switchTab('api'); // Force to API tab if no password
            }
        });

        // --- Users Logic ---
        async function loadUsers() {
            const pwd = getAdminPassword();
            if (!pwd) return;

            try {
                const res = await fetch(`/api/admin/users?password=${pwd}`);
                if (res.status === 401) {
                    alert('å¯†ç é”™è¯¯æˆ–æœªæˆæƒ');
                    switchTab('api');
                    return;
                }
                const users = await res.json();
                renderUsers(users);
            } catch (e) {
                console.error('Failed to load users', e);
            }
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-list');
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>#${user.id}</td>
                    <td><strong>${user.username}</strong></td>
                    <td>${user.email || '-'}</td>
                    <td><span style="color: #ff4757; font-weight: bold;">${user.balance.toFixed(1)}</span></td>
                    <td>${user.is_active ? '<span style="color:green">â— æ­£å¸¸</span>' : '<span style="color:red">â— ç¦ç”¨</span>'}</td>
                    <td>
                        <button class="secondary-btn btn-small" onclick="editBalance(${user.id}, '${user.username}', ${user.balance})">âœï¸ ä¿®æ”¹ä½™é¢</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function editBalance(userId, username, currentBalance) {
            const pwd = getAdminPassword();
            const newAmount = prompt(`ä¿®æ”¹ç”¨æˆ· ${username} çš„ä½™é¢\nå½“å‰ä½™é¢: ${currentBalance}`, currentBalance);
            
            if (newAmount === null) return; // Cancelled
            const amount = parseFloat(newAmount);
            if (isNaN(amount)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
                return;
            }

            try {
                const res = await fetch(`/api/admin/users/${userId}/balance`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password: pwd, amount: amount })
                });
                
                if (res.ok) {
                    alert('ä¿®æ”¹æˆåŠŸ');
                    loadUsers();
                } else {
                    const err = await res.json();
                    alert('ä¿®æ”¹å¤±è´¥: ' + err.detail);
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }

        // --- Pricing Logic ---
        async function loadPricing() {
            const pwd = getAdminPassword();
            if (!pwd) return;

            try {
                const res = await fetch(`/api/admin/pricing?password=${pwd}`);
                if (res.ok) {
                    const pricing = await res.json();
                    document.getElementById('price-video').value = pricing.video;
                    document.getElementById('price-image').value = pricing.image;
                    document.getElementById('price-music').value = pricing.music;
                    document.getElementById('price-avatar').value = pricing.avatar;
                }
            } catch (e) {
                console.error('Failed to load pricing', e);
            }
        }

        async function savePricing() {
            const pwd = getAdminPassword();
            if (!pwd) {
                alert('è¯·å…ˆè®¾ç½®ç®¡ç†å¯†ç ');
                switchTab('api');
                return;
            }

            const data = {
                password: pwd,
                video: parseFloat(document.getElementById('price-video').value) || 0,
                image: parseFloat(document.getElementById('price-image').value) || 0,
                music: parseFloat(document.getElementById('price-music').value) || 0,
                avatar: parseFloat(document.getElementById('price-avatar').value) || 0
            };

            try {
                const res = await fetch('/api/admin/pricing', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    alert('ä»·æ ¼é…ç½®å·²ä¿å­˜');
                } else {
                    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†ç ');
                }
            } catch (e) {
                alert('ç½‘ç»œé”™è¯¯');
            }
        }
    </script>
</body>
</html>